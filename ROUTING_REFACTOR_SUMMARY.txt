================================================================================
WEIGHTED ROUTING REFACTORING - EXECUTIVE SUMMARY
================================================================================

PROJECT: passport-scorer
STATUS: 30% Complete - Core infrastructure done, integration incomplete
LAST UPDATED: 2025-11-21

================================================================================
KEY FINDINGS
================================================================================

1. NEW INFRASTRUCTURE SUCCESSFULLY CREATED
   âœ… routing-utils.ts - Lambda/target group/routing primitives
   âœ… routing-rules.ts - Centralized routing configuration
   âœ… These files are well-designed and ready to use

2. PARTIALLY INTEGRATED
   âœ… V2 API endpoints refactored (uses new infrastructure)
   âš ï¸ Rust scorer cleaned up but has critical bugs
   âŒ Ceramic Cache (9 endpoints) - still using old buildHttpLambdaFn()
   âŒ Embed (3 endpoints) - still using createEmbedLambdaGeneric()
   âŒ App API (2 endpoints) - still using createAppLambdaGeneric()
   âŒ Central routing never wired up (configureAllRouting() not called)

3. CRITICAL BUGS BLOCKING DEPLOYMENT
   ğŸ› BUG #1: rust-scorer.ts line 186 references undefined variable
      â””â”€ Returns: rustScorerInternal: internalTargetGroup
      â””â”€ Impact: Deployment will crash
      â””â”€ Fix: Add 15 lines of code to create internal target group

   ğŸ› BUG #2: No internal ALB integration in createRustScorerLambda()
      â””â”€ Function receives internalHttpsListener but never uses it
      â””â”€ Missing target group creation for embed endpoints
      â””â”€ Part of Bug #1 fix

================================================================================
WHAT WAS SUPPOSED TO BE DONE (30% of scope)
================================================================================

According to commit 7798a57:
- Create routing infrastructure âœ… DONE
- Refactor V2 API endpoints âœ… DONE
- Clean up rust-scorer âœ… DONE (but buggy)
- Write implementation guide âœ… DONE

Remaining work (70% of scope):
- Refactor 14 more Lambda endpoints (ceramic cache, embed, app API)
- Wire up central routing configuration
- Delete old functions (buildHttpLambdaFn, createEmbedLambdaGeneric)
- Test weighted routing

================================================================================
IMMEDIATE ACTION REQUIRED
================================================================================

BEFORE any further development:
  1. Fix Bug #1 in rust-scorer.ts (15 lines of code)
  2. Test TypeScript compilation succeeds
  3. Verify Pulumi preview shows no errors

THEN can proceed with remaining phases 2-6

================================================================================
REFACTORING ROADMAP (6 Phases, 5-6 hours total)
================================================================================

Phase 1: Fix Critical Bugs (30 min) â­ DO THIS FIRST
â”œâ”€ File: infra/aws/v2/rust-scorer.ts
â”œâ”€ Add internal target group creation
â”œâ”€ Test compilation
â””â”€ Status: BLOCKING all other work

Phase 2: Refactor Ceramic Cache (2-3 hours)
â”œâ”€ File: infra/aws/index.ts (lines 1285-1492)
â”œâ”€ Endpoints: 9 (submit-passport, ceramic-cache, weights, analysis)
â”œâ”€ Replace: buildHttpLambdaFn() calls
â”œâ”€ With: createLambdaFunction() + createLambdaTargetGroup()
â””â”€ Status: Large but straightforward

Phase 3: Refactor Embed (1 hour)
â”œâ”€ File: infra/aws/embed/index.ts
â”œâ”€ Endpoints: 3 (add-stamps, validate-key, get-score)
â”œâ”€ Replace: createEmbedLambdaGeneric() calls
â”œâ”€ With: createLambdaFunction() + createLambdaTargetGroup()
â””â”€ Status: Straightforward

Phase 4: Refactor App API (30 min)
â”œâ”€ File: infra/aws/app_api/index.ts
â”œâ”€ Endpoints: 2 (nonce, authenticate)
â”œâ”€ Replace: createAppLambdaGeneric() calls
â”œâ”€ With: createLambdaFunction() + createLambdaTargetGroup()
â””â”€ Status: Straightforward

Phase 5: Wire Central Routing (1 hour)
â”œâ”€ File: infra/aws/index.ts (add configureAllRouting() call)
â”œâ”€ File: infra/lib/scorer/routing-rules.ts (add target groups)
â”œâ”€ Call: configureAllRouting() with all target groups
â”œâ”€ Remove: any manual listener rule creation
â””â”€ Status: Requires collecting all target groups

Phase 6: Cleanup (15 min)
â”œâ”€ Delete: buildHttpLambdaFn() from new_service.ts
â”œâ”€ Delete: createEmbedLambdaGeneric from embed/lambda_generic.ts
â”œâ”€ Delete: createAppLambdaGeneric from app_api/lambda_generic.ts
â”œâ”€ Delete: embed/lambda_generic.ts file
â”œâ”€ Delete: app_api/lambda_generic.ts file
â””â”€ Status: Final cleanup

================================================================================
ARCHITECTURE CHANGES
================================================================================

OLD PATTERN (all 14 endpoints using this):
  buildHttpLambdaFn() or createEmbedLambdaGeneric()
  â””â”€ Creates: Lambda + Target Group + Listener Rule (all in one)
  â””â”€ Problem: Creates ALB priority conflicts, no weighted routing support

NEW PATTERN (V2 API already using this, rest need to):
  createLambdaFunction() + createLambdaTargetGroup() + configureAllRouting()
  â””â”€ createLambdaFunction() creates: Lambda only
  â””â”€ createLambdaTargetGroup() creates: Target Group + Permissions
  â””â”€ configureAllRouting() creates: All Listener Rules (centralized)
  â””â”€ Benefit: Enables weighted routing, no conflicts, easier maintenance

================================================================================
TARGET ENDPOINTS INVENTORY
================================================================================

ENDPOINT DISTRIBUTION BY FILE:

V2 API (2 endpoints) - infra/aws/v2/index.ts
â”œâ”€ /v2/models/score/* (Python only)
â””â”€ /v2/stamps/{scorer_id}/score/* (Python + Rust)

Ceramic Cache (9 endpoints) - infra/aws/index.ts
â”œâ”€ /submit-passport (POST)
â”œâ”€ /ceramic-cache/score/* (POST, GET)
â”œâ”€ /ceramic-cache/stamps/bulk (POST, PATCH, DELETE)
â”œâ”€ /ceramic-cache/stamps (GET)
â”œâ”€ /ceramic-cache/weights (GET)
â””â”€ /passport/analysis/* (GET)

Embed (3 endpoints) - infra/aws/embed/index.ts
â”œâ”€ /internal/embed/stamps/* (POST)
â”œâ”€ /internal/embed/validate-api-key (GET)
â””â”€ /internal/embed/score/*/* (GET)

App API (2 endpoints) - infra/aws/app_api/index.ts
â”œâ”€ /account/nonce (GET/OPTIONS)
â””â”€ /ceramic-cache/authenticate (POST/OPTIONS)

TOTAL: 16 endpoints

================================================================================
KEY IMPLEMENTATION PATTERNS
================================================================================

PATTERN 1: Creating a Lambda (no routing)
â””â”€ Use: createLambdaFunction()
â””â”€ Parameters: name, dockerImage, dockerCommand, environment, etc.
â””â”€ Returns: aws.lambda.Function

PATTERN 2: Creating a Target Group
â””â”€ Use: createLambdaTargetGroup()
â””â”€ Parameters: name, lambda, vpcId
â””â”€ Returns: aws.lb.TargetGroup (with permissions granted)

PATTERN 3: Creating Routing Rules (centralized)
â””â”€ Use: configureAllRouting()
â””â”€ Parameters: listeners, targetGroups object, stack, envName
â””â”€ Creates: All listener rules in ONE place
â””â”€ Supports: Weighted routing, session stickiness, environment-based %

PATTERN 4: Collecting Target Groups
â””â”€ From each creation function: return collected target groups
â””â”€ To routing function: pass as TargetGroups interface object
â””â”€ Result: Single source of truth for all routing

================================================================================
FILES TO MODIFY
================================================================================

MUST MODIFY (in order):
1. âœ… infra/lib/scorer/routing-utils.ts (ALREADY DONE)
2. âœ… infra/lib/scorer/routing-rules.ts (ALREADY DONE)
3. âœ… infra/aws/v2/index.ts (ALREADY DONE)
4. âš ï¸ infra/aws/v2/rust-scorer.ts (HAS BUGS - FIX FIRST)
5. âŒ infra/aws/index.ts (CERAMIC CACHE - needs refactoring)
6. âŒ infra/aws/embed/index.ts (EMBED - needs refactoring)
7. âŒ infra/aws/app_api/index.ts (APP API - needs refactoring)

MUST DELETE (after refactoring):
1. buildHttpLambdaFn() from infra/lib/scorer/new_service.ts
2. createEmbedLambdaGeneric from infra/aws/embed/lambda_generic.ts
3. infra/aws/embed/lambda_generic.ts file
4. infra/aws/app_api/lambda_generic.ts file

FILES TO UPDATE (interfaces):
1. infra/lib/scorer/routing-rules.ts - Add target groups to TargetGroups interface

================================================================================
IMPLEMENTATION EFFORT ESTIMATE
================================================================================

Phase 1 (Fix bugs): 30 minutes â­ CRITICAL
Phase 2 (Ceramic cache): 2-3 hours
Phase 3 (Embed): 1 hour
Phase 4 (App API): 30 minutes
Phase 5 (Wire routing): 1 hour
Phase 6 (Cleanup): 15 minutes

TOTAL: 5-6 hours for complete refactoring
CRITICAL PATH: 30 minutes to fix bugs and unblock

================================================================================
SUCCESS CRITERIA
================================================================================

âœ… Phase 1 Complete:
  - No undefined variable references
  - TypeScript compilation succeeds
  - Pulumi preview shows no errors

âœ… Phase 2-6 Complete:
  - All 14 endpoints refactored
  - All listener rules in configureAllRouting()
  - Old functions deleted
  - All tests pass
  - Weighted routing enabled in staging

================================================================================
DOCUMENTATION REFERENCES
================================================================================

Detailed Analysis:
  â†’ /workspace/project/WEIGHTED_ROUTING_CURRENT_STATE.md

Quick Reference:
  â†’ /workspace/project/WEIGHTED_ROUTING_QUICK_REFERENCE.md

Original Implementation Guide:
  â†’ /workspace/project/WEIGHTED_ROUTING_IMPLEMENTATION_GUIDE.md

Source Files:
  â†’ infra/lib/scorer/routing-utils.ts (NEW)
  â†’ infra/lib/scorer/routing-rules.ts (NEW)
  â†’ infra/aws/v2/index.ts (REFACTORED)
  â†’ infra/aws/v2/rust-scorer.ts (HAS BUGS)

================================================================================
NEXT STEPS
================================================================================

1. Read WEIGHTED_ROUTING_QUICK_REFERENCE.md for exact bug fix
2. Apply the 15-line fix to rust-scorer.ts
3. Test TypeScript compilation: npm run build
4. Then proceed with Phases 2-6

DO NOT proceed with further development until Phase 1 is complete.

================================================================================
