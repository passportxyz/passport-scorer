# Database Schema Reference for Rust Implementation

## Critical Schema Findings

### 1. Primary Key Types (IMPORTANT!)
Most tables use **BIGINT (i64)** for primary keys, NOT INTEGER (i32):
- All `id` columns are BIGINT with GENERATED BY DEFAULT AS IDENTITY
- Foreign keys must match: use `i64` in Rust, not `i32`

### 2. Missing Composite Index on HashScorerLink
**THIS IS THE PERFORMANCE BOTTLENECK!**

Current indexes on `registry_hashscorerlink`:
- `hash` (single column)
- `community_id` (single column)
- `address` (single column)
- `expires_at` (single column)

**Missing**: Composite index on `(hash, community_id)` which is needed for the LIFO query:
```sql
WHERE hash = ANY($1) AND community_id = $2
```

**Fix immediately**:
```sql
CREATE INDEX CONCURRENTLY idx_hashscorerlink_hash_community
ON registry_hashscorerlink(hash, community_id)
INCLUDE (address, expires_at);
```

## Core Tables Schema

### 1. ceramic_cache_ceramiccache (line 622)
```sql
CREATE TABLE public.ceramic_cache_ceramiccache (
    id bigint NOT NULL,                           -- i64
    address character varying(100),               -- Option<String>
    provider character varying(256) NOT NULL,     -- String
    stamp jsonb NOT NULL,                        -- serde_json::Value
    created_at timestamp with time zone,         -- Option<DateTime<Utc>>
    updated_at timestamp with time zone NOT NULL, -- DateTime<Utc>
    type integer NOT NULL,                       -- i32 (1 for V1)
    deleted_at timestamp with time zone,         -- Option<DateTime<Utc>>
    compose_db_save_status character varying(10) NOT NULL, -- String ("pending")
    compose_db_stream_id character varying(100) NOT NULL,  -- String
    expiration_date timestamp with time zone,    -- Option<DateTime<Utc>>
    issuance_date timestamp with time zone,      -- Option<DateTime<Utc>>
    proof_value character varying(256) NOT NULL, -- String
    source_app integer,                          -- Option<i32>
    source_scorer_id bigint                      -- Option<i64>
);
```
**Note**: Table name is `ceramic_cache_ceramiccache`, not just `ceramic_cache`!

### 2. registry_passport (line 1826)
```sql
CREATE TABLE public.registry_passport (
    id bigint NOT NULL,                    -- i64
    community_id bigint,                   -- Option<i64>
    address character varying(100),        -- Option<String>
    requires_calculation boolean           -- Option<bool>
);
```
**Note**: NO created_at/updated_at fields!

### 3. registry_score (line 1852)
```sql
CREATE TABLE public.registry_score (
    id bigint NOT NULL,                        -- i64
    score numeric(18,9),                       -- Option<Decimal>
    passport_id bigint NOT NULL,               -- i64
    error text,                                -- Option<String>
    last_score_timestamp timestamp with time zone, -- Option<DateTime<Utc>>
    status character varying(20),              -- Option<String>
    evidence jsonb,                            -- Option<serde_json::Value>
    stamp_scores jsonb,                        -- Option<serde_json::Value>
    expiration_date timestamp with time zone,  -- Option<DateTime<Utc>>
    stamps jsonb                               -- Option<serde_json::Value>
);
```

### 4. registry_stamp (line 1884)
```sql
CREATE TABLE public.registry_stamp (
    id bigint NOT NULL,                    -- i64
    provider character varying(256) NOT NULL, -- String
    credential jsonb NOT NULL,              -- serde_json::Value
    passport_id bigint                     -- Option<i64>
);
```

### 5. registry_hashscorerlink (line 1611)
```sql
CREATE TABLE public.registry_hashscorerlink (
    id bigint NOT NULL,                    -- i64
    hash character varying(100) NOT NULL,  -- String
    address character varying(42) NOT NULL, -- String
    expires_at timestamp with time zone NOT NULL, -- DateTime<Utc>
    community_id bigint NOT NULL           -- i64
);
```
**Unique constraint**: `(hash, community_id)` - line 5445

### 6. account_accountapikey (line 50)
```sql
CREATE TABLE public.account_accountapikey (
    id character varying(150) NOT NULL,    -- String (UUID format)
    prefix character varying(8) NOT NULL,  -- String
    hashed_key character varying(150) NOT NULL, -- String
    created timestamp with time zone NOT NULL,  -- DateTime<Utc>
    name character varying(50) NOT NULL,   -- String
    revoked boolean NOT NULL,              -- bool
    expiry_date timestamp with time zone,  -- Option<DateTime<Utc>>
    account_id bigint NOT NULL,            -- i64
    rate_limit character varying(20),      -- Option<String>
    create_scorers boolean NOT NULL,       -- bool
    read_scores boolean NOT NULL,          -- bool
    submit_passports boolean NOT NULL,     -- bool
    analysis_rate_limit character varying(20), -- Option<String>
    historical_endpoint boolean NOT NULL,  -- bool
    embed_rate_limit character varying(20), -- Option<String>
    hashed_key_sha256 character varying(71) -- Option<String> NEW!
);
```

### 7. registry_humanpoints (line 1638)
```sql
CREATE TABLE public.registry_humanpoints (
    id bigint NOT NULL,                    -- i64
    address character varying(42) NOT NULL, -- String
    action character varying(3) NOT NULL,  -- String
    timestamp timestamp with time zone NOT NULL, -- DateTime<Utc>
    tx_hash character varying(100) NOT NULL, -- String
    chain_id integer NOT NULL,             -- i32
    provider character varying(100) NOT NULL -- String (can be empty!)
);
```
**Note**: `provider` is NOT NULL but Django converts None to empty string!

### 8. account_community (line 184)
```sql
CREATE TABLE public.account_community (
    id bigint NOT NULL,                    -- i64
    name character varying(100) NOT NULL,  -- String
    description character varying(100) NOT NULL, -- String
    account_id bigint NOT NULL,            -- i64
    scorer_id bigint NOT NULL,             -- i64
    created_at timestamp with time zone,   -- Option<DateTime<Utc>>
    rule character varying(100) NOT NULL,  -- String
    use_case character varying(100),       -- Option<String>
    deleted_at timestamp with time zone,   -- Option<DateTime<Utc>>
    external_scorer_id character varying(42), -- Option<String>
    human_points_program boolean NOT NULL  -- bool
);
```

### 9. scorer_weighted_binaryweightedscorer (line 2086)
```sql
CREATE TABLE public.scorer_weighted_binaryweightedscorer (
    scorer_ptr_id bigint NOT NULL,         -- i64 (references scorer.id)
    weights jsonb,                         -- Option<serde_json::Value>
    threshold numeric(10,5) NOT NULL       -- Decimal
);
```

### 10. scorer_weighted_weightedscorer (line 2150)
```sql
CREATE TABLE public.scorer_weighted_weightedscorer (
    scorer_ptr_id bigint NOT NULL,         -- i64 (references scorer.id)
    weights jsonb,                         -- Option<serde_json::Value>
    threshold numeric(10,5) NOT NULL       -- Decimal
);
```

## Rust Type Mappings

```rust
// PostgreSQL -> Rust type mappings
// bigint                    -> i64
// integer                   -> i32
// character varying(n)      -> String
// text                      -> String
// boolean                   -> bool
// timestamp with time zone  -> DateTime<Utc>
// jsonb                     -> serde_json::Value
// numeric(18,9)            -> rust_decimal::Decimal
// numeric(10,5)            -> rust_decimal::Decimal
```

## Critical Performance Indexes

### Currently Missing (URGENT)
```sql
-- Composite index for LIFO deduplication query
CREATE INDEX CONCURRENTLY idx_hashscorerlink_hash_community
ON registry_hashscorerlink(hash, community_id)
INCLUDE (address, expires_at);

-- For ceramic_cache queries
CREATE INDEX CONCURRENTLY idx_ceramic_cache_address_provider
ON ceramic_cache_ceramiccache(address, provider)
WHERE deleted_at IS NULL AND type = 1;
```

### Existing Indexes (Good)
- `registry_hashscorerlink_hash_6798c065` on `hash`
- `registry_hashscorerlink_community_id_464dfa88` on `community_id`
- `account_accountapikey_prefix_c5b7b286_like` on `prefix`

## Django-Specific Gotchas

1. **Table Naming**: Django adds app prefix, e.g., `ceramic_cache_ceramiccache` not `ceramic_cache`
2. **Missing Timestamps**: Many tables don't have created_at/updated_at despite model definitions
3. **CharField Nulls**: Django converts None to empty string for CharField with null=False
4. **JSONField**: Always use JSONB, never JSON
5. **Status Fields**: Usually VARCHAR(20) with specific Django choices

## SQL Optimization Queries

```sql
-- Check table sizes
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    n_live_tup as rows
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 20;

-- Check for missing indexes on foreign keys
SELECT
    tc.table_name,
    kcu.column_name,
    'CREATE INDEX idx_' || tc.table_name || '_' || kcu.column_name ||
    ' ON ' || tc.table_name || '(' || kcu.column_name || ');' as index_sql
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu
    ON tc.constraint_name = kcu.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE tablename = tc.table_name
        AND indexdef LIKE '%' || kcu.column_name || '%'
    );
```

## Implementation Checklist

- [ ] Update all primary keys to use `i64` not `i32`
- [ ] Create composite index on `registry_hashscorerlink(hash, community_id)`
- [ ] Use correct table name `ceramic_cache_ceramiccache`
- [ ] Handle empty strings for `provider` field in human_points
- [ ] Check both BinaryWeightedScorer and WeightedScorer tables
- [ ] Use JSONB type for all JSON fields
- [ ] Remember no timestamps on passport/stamp tables