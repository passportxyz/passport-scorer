# Weighted Routing Refactoring - Analysis Index

## Quick Links by Topic

### Start Here
- **ROUTING_REFACTOR_SUMMARY.txt** - Executive summary of current state and what needs to be done
- **WEIGHTED_ROUTING_QUICK_REFERENCE.md** - Quick reference with exact code fix needed

### Detailed Analysis
- **WEIGHTED_ROUTING_CURRENT_STATE.md** - Complete 400+ line analysis with all details
  - Current state breakdown (30% done)
  - Bugs found and impact analysis
  - File structure overview
  - Function dependencies
  - Target groups inventory
  - 6-phase implementation roadmap

### Implementation Guides
- **WEIGHTED_ROUTING_IMPLEMENTATION_GUIDE.md** - Original comprehensive guide
- **WEIGHTED_ROUTING_BLOCKER_ANALYSIS.md** - AWS ALB constraint analysis
- **RUST_WEIGHTED_ROUTING_HANDOFF.md** - Handoff documentation

---

## Current Status Summary

**Overall Progress**: 30% Complete

**What's Working:**
- ‚úÖ New routing infrastructure created (routing-utils.ts, routing-rules.ts)
- ‚úÖ V2 API endpoints refactored
- ‚úÖ Rust scorer cleaned up (removed 300+ lines)

**Critical Bugs:**
- üêõ rust-scorer.ts has undefined variable (line 186)
- üêõ No internal ALB integration for embed endpoints

**What Still Needs Work:**
- ‚ùå Ceramic Cache endpoints (9 lambdas)
- ‚ùå Embed endpoints (3 lambdas) 
- ‚ùå App API endpoints (2 lambdas)
- ‚ùå Central routing not wired up

---

## Phase Breakdown

| Phase | Task | Time | Status |
|-------|------|------|--------|
| 1 | Fix critical bugs | 30 min | ‚ö†Ô∏è BLOCKED |
| 2 | Refactor ceramic cache | 2-3 hrs | ‚è≥ Not started |
| 3 | Refactor embed | 1 hr | ‚è≥ Not started |
| 4 | Refactor app API | 30 min | ‚è≥ Not started |
| 5 | Wire central routing | 1 hr | ‚è≥ Not started |
| 6 | Cleanup old code | 15 min | ‚è≥ Not started |

**Total**: 5-6 hours for complete refactoring
**Critical Path**: 30 minutes to fix bugs

---

## Key Files

### New Infrastructure (Ready to Use)
- `infra/lib/scorer/routing-utils.ts` - Lambda/target group/routing primitives
- `infra/lib/scorer/routing-rules.ts` - Centralized routing configuration

### Refactored (Complete)
- `infra/aws/v2/index.ts` - Uses new infrastructure pattern
- `infra/aws/v2/rust-scorer.ts` - Cleaned up but has bugs

### To Be Refactored
- `infra/aws/index.ts` - Ceramic cache (9 endpoints)
- `infra/aws/embed/index.ts` - Embed (3 endpoints)
- `infra/aws/app_api/index.ts` - App API (2 endpoints)

### To Be Deleted
- `buildHttpLambdaFn()` from `infra/lib/scorer/new_service.ts`
- `createEmbedLambdaGeneric()` from `infra/aws/embed/lambda_generic.ts`
- `infra/aws/embed/lambda_generic.ts` file
- `infra/aws/app_api/lambda_generic.ts` file

---

## The Bug (Quick Fix)

**File:** `infra/aws/v2/rust-scorer.ts`
**Line:** 186
**Problem:** References undefined `internalTargetGroup`

**Solution:** Add 15 lines of code before return statement to create the internal target group.

See **WEIGHTED_ROUTING_QUICK_REFERENCE.md** for exact code.

---

## Architecture Change

**Old Pattern** (causes conflicts):
```
buildHttpLambdaFn() ‚Üí Creates Lambda + TG + Rules
```

**New Pattern** (supports weighted routing):
```
createLambdaFunction() ‚Üí Creates Lambda
createLambdaTargetGroup() ‚Üí Creates TG + Permissions  
configureAllRouting() ‚Üí Creates ALL Rules Centrally
```

---

## Next Steps

1. Read **ROUTING_REFACTOR_SUMMARY.txt**
2. Read **WEIGHTED_ROUTING_QUICK_REFERENCE.md**
3. Fix the bug in rust-scorer.ts
4. Test compilation: `npm run build`
5. Follow Phase 2-6 roadmap

---

## Documentation Generated

This analysis was generated by systematically exploring:
- `infra/lib/scorer/routing-utils.ts` (202 lines)
- `infra/lib/scorer/routing-rules.ts` (368 lines)
- `infra/aws/v2/index.ts` (237 lines)
- `infra/aws/v2/rust-scorer.ts` (189 lines)
- `infra/aws/index.ts` (1500+ lines)
- `infra/aws/embed/` (153 lines)
- `infra/aws/app_api/` (54 lines)
- `infra/lib/scorer/new_service.ts` (900+ lines)

---

Last Updated: 2025-11-21
Analysis Version: 1.0
Status: Ready for implementation
